function startGame() {
    console.log("Start Game button clicked");
    titleScreen.classList.add('hidden');
    canvas.classList.remove('hidden');
    muteButton.classList.remove('hidden');
    backgroundMusic.play();
    console.log("Background music started");

    resetGame();
    gameRunning = true;
    console.log("Game loop started");
    gameLoop();
}

function moveSpaceship() {
    spaceship.x += spaceship.speed;
    if (spaceship.x <= 0 || spaceship.x + spaceship.width >= canvas.width) {
        spaceship.speed *= -1;
        console.log("Spaceship changed direction");
    }
}

function generatePlatforms() {
    console.log("Generating platforms...");
    platforms.length = 0;
    platforms.push({ x: 0, y: canvas.height - 20, width: canvas.width, height: 20 });
    const count = Math.min(level + 3, 8);
    for (let i = 1; i <= count; i++) {
        const width = Math.random() * 150 + 100;
        const x = Math.random() * (canvas.width - width);
        const y = canvas.height - i * 100;
        platforms.push({ x, y, width, height: 20 });
    }
    console.log("Platforms generated:", platforms);
}

function gameLoop() {
    if (!gameRunning) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawPlatforms();

    if (!dog.onGround) dog.velocityY += dog.gravity;
    dog.y += dog.velocityY;
    dog.onGround = false;

    platforms.forEach(p => {
        if (
            dog.x < p.x + p.width &&
            dog.x + dog.width > p.x &&
            dog.y + dog.height >= p.y &&
            dog.y + dog.height <= p.y + p.height
        ) {
            dog.y = p.y - dog.height;
            dog.velocityY = 0;
            dog.onGround = true;
        }
    });

    ctx.drawImage(dogImage, dog.x, dog.y, dog.width, dog.height);

    moveSpaceship();
    ctx.drawImage(spaceshipImage, spaceship.x, spaceship.y, spaceship.width, spaceship.height);

    if (Math.random() < 0.02 * level) {
        bags.push(new Bag(dog.x + dog.width / 2));
        console.log("Bag spawned targeting dog at x:", dog.x);
    }

    bags.forEach((bag, i) => {
        bag.update();
        bag.draw();

        if (
            dog.x < bag.x + bag.width &&
            dog.x + dog.width > bag.x &&
            dog.y < bag.y + bag.height &&
            dog.y + dog.height > bag.y
        ) {
            console.log("Dog hit by bag");
            endGame();
        }

        if (bag.y > canvas.height) {
            console.log("Bag removed (offscreen)");
            bags.splice(i, 1);
        }
    });

    ctx.drawImage(boneImage, canvas.width / 2 - 40, 20, 80, 80);

    if (
        dog.x < canvas.width / 2 + 40 &&
        dog.x + dog.width > canvas.width / 2 - 40 &&
        dog.y < 100
    ) {
        console.log("Dog reached the bone. Level up!");
        level++;
        score += 100;
        generatePlatforms();
    }

    ctx.fillStyle = 'white';
    ctx.fillText(`Score: ${score}`, 10, 20);
    ctx.fillText(`Level: ${level}`, 10, 40);

    requestAnimationFrame(gameLoop);
}

function endGame() {
    console.log("Game Over. Final Score:", score);
    gameRunning = false;
    backgroundMusic.pause();
    alert(`Game Over!\nScore: ${score}`);
    resetGame();
}
